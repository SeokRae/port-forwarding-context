# ADR-002: 마이크로서비스 통합 테스트를 위한 트래픽 라우팅 전략

## 작성 정보

- 작성일: 2024-01-04
- 작성자: [김석래](https://github.com/seokrae)
- 상태: 제안됨

## 배경 및 문제 정의

### 현재 상황

- 3개의 마이크로서비스가 상호작용하는 분산 트랜잭션 환경
- 라운드로빈 방식의 로드밸런싱 적용
- 테스트 환경에서 특정 서비스 인스턴스 호출 어려움
- 통합 테스트 시 예측 가능한 시나리오 구성 필요

### 해결해야 할 문제

- 테스트 환경에서 특정 서비스 인스턴스로 트래픽 라우팅
- 분산 환경에서의 일관된 테스트 시나리오 구성
- 헤더 기반 라우팅 메커니즘 구현
- 테스트와 프로덕션 환경의 설정 분리

### 영향 범위

- 애플리케이션 소스코드
    - HTTP 헤더 처리 로직 추가
    - 포트 설정 및 바인딩 관련 코드 수정
    - 테스트 환경 구성 코드
- 인프라 구성
    - 방화벽 규칙 및 L4 설정
    - 포트 바인딩 설정
    - 네트워크 ACL 정책
- 운영 도구
    - 통합 테스트 프레임워크
    - 서비스 디스커버리 시스템
    - 로드밸런서 설정
    - CI/CD 파이프라인
- 모니터링 및 로깅
    - 헤더 기반 라우팅 로그 추가
    - 테스트 트래픽 모니터링 구성

## 의사결정 내용

### 기술적 결정사항

- 구현 방향:
    - HTTP 헤더 기반 라우팅 구현
    - X-Test-Port 헤더를 통한 대상 포트 지정
    - 테스트 환경 전용 라우팅 규칙 적용
- 기술 스택:
    - Spring Boot 프레임워크
    - ServletFilter 구현
    - ThreadLocal을 통한 요청 스코프 컨텍스트 관리
    - RestTemplate Customizing
- 아키텍처 구조:
    - 서블릿 필터 레벨에서 헤더 처리
    - ThreadLocal을 통한 포트 정보 전파
    - 외부 API 호출 시점에 포트 정보 적용
    - 비즈니스 로직 레이어 영향도 최소화

### 운영 관점 고려사항

- 시스템 안정성:
    - 테스트/운영 환경 설정 분리
    - 헤더 검증 및 유효성 검사
    - 잘못된 라우팅 요청 차단 및 알림
    - 테스트 트래픽으로 인한 운영 서비스 영향도 최소화
    - 장애 격리(Circuit Breaker) 전략
        - 임계값 설정
            - 에러율 기준 (예: 50% 이상)
            - 응답 시간 기준 (예: 3초 이상)
            - 연속 실패 횟수 (예: 10회 이상)
        - Circuit Open 시 동작
            - Fallback 응답 정의
            - 기본 에러 응답 처리
            - 로깅 및 알림 정책
        - 복구 전략
            - Half-Open 상태 전환 시간 (예: 30초)
            - 자동 복구 시도 주기
            - 수동 개입 정책
        - 모니터링
            - Circuit 상태 변경 이력
            - 실패율 및 응답시간 추이
            - 서비스별 Circuit 현황
- 모니터링 계획:
    - 테스트 트래픽 별도 추적 및 로깅
    - 라우팅 패턴 모니터링 및 분석
    - 테스트 케이스 성공률 대시보드
    - 리소스 사용량 모니터링
- 장애 대응 전략:
    - 테스트 환경 장애 시 운영 환경 보호
    - 비정상 트래픽 탐지 및 차단
    - 장애 발생 시 롤백 프로세스
    - 긴급 상황 시 테스트 트래픽 차단 정책

### 비즈니스 가치

- 기대효과:
    - 테스트 신뢰성 향상
        - 현재: 배포 중 테스트 불가로 인한 버그 발견 지연 (월 평균 4건)
        - 개선 후: L4 제외 상태에서도 테스트 가능 (사전 발견 예상 3건)
        - 개선율: 버그 사전 발견률 75% 향상

    - 배포 프로세스 개선
        - 현재: 배포당 평균 테스트 대기 시간 30분
        - 개선 후: 대기 시간 없이 즉시 테스트 가능
        - 개선율: 배포 소요 시간 25% 단축

    - 운영 리스크 감소
        - 현재: 월 평균 긴급 배포 3회
        - 개선 후: 예상 긴급 배포 1회 이하
        - 개선율: 긴급 배포 60% 감소

- 비용 분석:
    - 현재 발생 비용 (월 평균)
        - 긴급 배포 대응: 건당 4시간 × 3회 = 12시간
        - 장애 처리: 건당 2시간 × 4건 = 8시간
        - QA 대기 시간: 건당 30분 × 20회 = 10시간
        - 총 공수: 30시간/월

    - 개선 후 예상 비용
        - 긴급 배포 대응: 건당 4시간 × 1회 = 4시간
        - 장애 처리: 건당 2시간 × 1건 = 2시간
        - QA 대기 시간: 제로
        - 총 공수: 6시간/월

    - ROI 분석
        - 월 절감 시간: 24시간
        - 연간 절감 비용: (24시간 × 12개월) × 시간당 인건비
        - 초기 개발 비용: 2주 × 40시간 × 시간당 인건비
        - 회수 기간: 약 3개월

- 서비스 품질 향상:
    - 고객 경험
        - 배포 중 서비스 품질 저하 최소화
        - 버그로 인한 고객 피해 80% 감소
    - 개발자 경험
        - 배포 프로세스 스트레스 감소
        - 테스트 유연성 확보
        - 야간/휴일 배포 부담 감소

## 대안 검토

### 1안: 서비스 메시 도입

- 장점:
    - 완벽한 트래픽 제어
    - 상세한 모니터링
    - 서비스 디스커버리 자동화
- 단점:
    - 높은 도입 비용
    - 복잡한 운영
    - 데이터센터 내 추가 인프라 구성 필요
    - 기존 네트워크 정책 변경 필요
- ROI 분석:
    - 초기 구축 비용: 높음 (인프라/라이선스)
    - 운영 비용: 중간 (전담 운영 인력 필요)
    - 회수 기간: 2년 이상 예상
- 기각 사유:
    - 현재 규모 대비 과도한 솔루션
    - 데이터센터 인프라 변경 범위가 큼

### 2안: 환경별 서비스 분리

- 장점:
    - 간단한 구현
    - 완벽한 격리
    - 기존 인프라 활용 가능
- 단점:
    - 물리 서버 리소스 낭비
    - 운영 복잡도 증가
    - 라이선스 비용 증가 (DB 등)
- ROI 분석:
    - 초기 구축 비용: 중간 (서버/라이선스)
    - 운영 비용: 높음 (환경별 관리 필요)
    - 회수 기간: 1년 이상 예상
- 기각 사유:
    - 데이터센터 자원 효율성 저하
    - 운영 비용 증가

## 구현 계획

### 마일스톤

1. Phase 1: 라우팅 메커니즘 구현 (1주)
    - 헤더 기반 라우팅 로직 개발 (3일)
        - ServletFilter 구현 (X-Test-Port 헤더 처리)
        - ThreadLocal 컨텍스트 관리
        - RestTemplate 커스터마이징
    - 테스트 프로파일 구성 (2일)
        - application-test.yml 설정
        - 테스트용 포트 바인딩 설정
    - 체크포인트
        - [ ] 단위 테스트 작성 완료
        - [ ] 헤더 기반 라우팅 동작 확인
        - [ ] 코드 리뷰 완료

2. Phase 2: 테스트 프레임워크 통합 및 안정화 (1주)
    - 통합 테스트 구현 (3일)
        - 주요 시나리오 테스트 케이스 작성
        - Jenkins 파이프라인 연동
        - 테스트 리포트 설정
    - 모니터링 및 안정화 (2일)
        - 기본 모니터링 지표 설정
        - 테스트 로그 포맷 정의
        - 운영 가이드 작성
    - 체크포인트
        - [ ] 전체 테스트 성공 확인
        - [ ] CI/CD 파이프라인 통합 완료
        - [ ] 기본 모니터링 구성 완료

### 리스크 관리

- 일일 스크럼을 통한 진행 상황 공유
- 핵심 기능 우선 구현 후 부가 기능 추가
- 문제 발생 시 즉시 팀 리드에게 에스컬레이션

### 담당자 및 역할

- 개발자 1: 라우팅 메커니즘 구현
- 개발자 2: 테스트 케이스 작성
- DevOps: CI/CD 파이프라인 연동

### 성공 기준

- 핵심 기능 구현 완료
    - 헤더 기반 라우팅
    - 기본 테스트 케이스
    - CI/CD 연동
- 테스트 성공률 95% 이상
- 코드 리뷰 완료

## 피드백 및 개선계획

- 피드백 수집 방법:
    - 개발팀 주간 리뷰
    - 테스트 결과 분석
    - 장애 보고서 검토
- 개선 프로세스:
    - 월간 테스트 전략 리뷰
    - 분기별 성능 개선
    - 지속적인 테스트 케이스 보완

---
#adr #architecture #testing #microservices #traffic-routing 