# ADR-003: 테스트 라우팅 필터의 멀티모듈 구조 전환

## 작성 정보

- 작성일: 2024-01-10
- 작성자: [김석래](https://github.com/seokrae)
- 상태: 승인됨
- 관련 ADR: [ADR-002: 마이크로서비스 통합 테스트를 위한 트래픽 라우팅 전략]

## 배경 및 문제 정의

### 현재 상황

- 각 마이크로서비스에 테스트 라우팅 필터 로직이 중복 구현됨
- 필터 로직 변경 시 모든 서비스의 코드 수정 필요
- 테스트 관련 공통 로직의 버전 관리가 어려움
- 서비스별 설정값 관리의 일관성 부족

### 해결해야 할 문제

- 테스트 라우팅 필터의 코드 중복 제거
- 공통 로직의 일관된 버전 관리
- 테스트 관련 설정의 중앙화
- 각 서비스의 독립성 유지
- 테스트 코드의 재사용성 향상

### 영향 범위

- 빌드 구조
    - Gradle 멀티모듈 설정
    - 의존성 관리 정책
    - 모듈간 의존관계
- 배포 프로세스
    - 공통 모듈 배포 전략
    - 버전 관리 정책
- 개발 프로세스
    - 코드 리뷰 정책
    - 테스트 전략
    - 문서화 요구사항

## 의사결정 내용

### 기술적 결정사항

- 모듈 구조:
  ```
  project-root/
  ├── filter-inbound-module/     # 공통 필터 모듈
  │   ├── core/                  # 핵심 인터페이스 및 설정
  │   ├── support/              # 유틸리티 및 헬퍼 클래스
  │   └── test/                 # 테스트 지원 클래스
  ├── source-server/            # 소스 서버 모듈
  ├── destination-a/            # 목적지 A 서버 모듈
  └── destination-b/            # 목적지 B 서버 모듈
  ```

- 모듈별 책임:
    - filter-inbound-module
        - 포트 검증 로직
        - 컨텍스트 관리
        - 공통 설정 정의
    - 각 서비스 모듈
        - 비즈니스 로직
        - 서비스별 설정
        - 통합 테스트

### 기대효과

- 코드 품질
    - 중복 코드 90% 감소
    - 버그 수정 시간 60% 단축
    - 테스트 커버리지 향상
- 유지보수성
    - 공통 로직 변경 시 1회 수정으로 전체 적용
    - 버전 관리 용이성 향상
    - 문서화 개선

### 구현 계획

1. Phase 1: 코어 모듈 분리
    - 공통 필터 로직 추출
    - 설정 클래스 정의
    - 단위 테스트 구성
    - 문서화

2. Phase 2: 서비스 연동
    - 의존성 설정
    - 기존 코드 제거
    - 통합 테스트 수행

## 대안 검토

### 1안: 독립 라이브러리 프로젝트로 분리

- 설명:
    - 필터 로직을 완전히 별도의 Git 저장소로 분리
    - Maven Central 또는 사내 Nexus 등에 배포하여 의존성으로 관리
- 장점:
    - 완전한 독립성과 재사용성
    - 다른 프로젝트에서도 사용 가능
    - 엄격한 버전 관리 가능
- 단점:
    - 별도 저장소 관리 필요
    - 라이브러리 배포 프로세스 추가
    - 버그 수정 시 배포-적용 사이클이 길어짐
- 기각 사유:
    - 현재 규모에서 과도한 복잡성
    - 빠른 개발/수정이 어려움
    - 현 단계에서는 외부 재사용 수요가 없음

### 2안: 공통 코드 복사

- 설명:
    - 각 마이크로서비스에 필터 로직을 개별적으로 복사하여 구현
    - 예시 구조:
      ```
      source-server/
      ├── src/main/java/
      │   └── filter/
      │       ├── ForwardedPortFilter.java    # 복사된 필터 로직
      │       ├── ForwardedPortContext.java   # 복사된 컨텍스트
      │       └── ForwardedPortValidator.java # 복사된 검증 로직
      
      destination-a/
      ├── src/main/java/
      │   └── filter/
      │       ├── ForwardedPortFilter.java    # 복사된 필터 로직
      │       ├── ForwardedPortContext.java   # 복사된 컨텍스트
      │       └── ForwardedPortValidator.java # 복사된 검증 로직
      ```
- 장점:
    - 간단한 구현
    - 서비스별 커스터마이징 용이
    - 즉각적인 수정 가능
- 단점:
    - 코드 중복
    - 버그 수정 시 전체 수정 필요
    - 일관성 유지 어려움
- 기각 사유:
    - 장기적 관점에서 유지보수 비용 증가
    - 품질 관리 어려움

## 모니터링 및 피드백

### 모니터링 지표

- 빌드 성능
    - 빌드 시간 변화
    - 테스트 실행 시간
    - 의존성 해결 시간
- 코드 품질
    - 테스트 커버리지
    - 정적 분석 결과
    - 중복 코드 비율

### 피드백 수집

- 개발자 피드백
    - 이슈 트래킹
- 운영 피드백
    - 유지보수 용이성 평가

### 개선 계획

- 코드 리뷰
    - 모듈 구조 개선
    - 의존성 최적화
- 문서화 개선
    - 설정 가이드 보완
    - 예제 코드 추가

---
#adr #architecture #multi-module #refactoring #testing 